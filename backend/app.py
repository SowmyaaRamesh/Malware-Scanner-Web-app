from flask import Flask,request,render_template
from preprocess import preprocessFile
from predict import getBinaryPrediction,getMulticlassPrediction
from flask_cors import CORS,cross_origin
from util import getMalwareFamilyName
import os
import json


template_dir = os.path.dirname(os.path.dirname(os.path.abspath(os.path.dirname(__file__))))
template_dir = os.path.join(template_dir, 'webapp')
save_path = os.path.join(template_dir,'backend\\files')

app = Flask(__name__,template_folder=template_dir)

CORS(app, support_credentials=True)
app.debug=True


@app.route('/upload', methods = ['POST'])
def upload_file():
    print("here")
    file = request.files['file']
    file.save(os.path.join(save_path,file.filename))
    print(os.path.join(save_path,file.filename))
    preprocessFile(file.filename)
    prediction = getBinaryPrediction()
    pred_family = ""
    if(prediction == 'Malicious'):
        pred_class = getMulticlassPrediction()
        pred_family = getMalwareFamilyName(pred_class)
    print(file)
    response_dict = {
        "binary_prediction": prediction,
        "multiclass_prediction": pred_family
    }

    response = json.dumps(response_dict)

    return response

# if __name__ == "__main__":
#     app.run(debug=True)